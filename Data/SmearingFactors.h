#ifndef SMEARINGFACTORS_H
#define SMEARINGFACTORS_H

#include <iostream>
#include <utility>
#include <TROOT.h>
#include <TStyle.h>

#include <TString.h>
#include <TRandom3.h>
#include <TF1.h>



void  LoadParameters();
int   GetCBin(int /*bin*/);

float GetPtBin(float /*smpt*/);

float GetSmFactor(int /*nj*/,int /*ic*/,float /*recopt*/);
float GetMeanShift(int /*nj*/,int /*ic*/,float /*recopt*/);
float AfterBurnMean(int /*nj*/,int /*ic*/,float /*smpt*/,float /*refpt*/);

float GetSmearedPtMC(int /*nj*/,int /*ic*/,float /*recopt*/,float /*refpt*/);
float GetSmearedPtMC_woAfBurn(int /*nj*/,int /*ic*/,float /*recopt*/,float /*refp*/);
float GetSmearedPtMC_NoMeanShift(int /*nj*/,int /*ic*/,float /*recopt*/,float /*refpt*/); //! JFF & JS
float GetSmearedPtMC_OnlyMeanShift(int /*nj*/,int /*ic*/,float /*recopt*/,float /*refpt*/);

float GetSmearedPtData(int /*nj*/,int /*ic*/,float /*recopt*/,float /*fpercent*/,const char */*csys*/);
float GetSmearedPtData_woAfBurn(int /*nj*/,int /*ic*/,float /*recopt*/,float /*fpercent*/,const char */*csys*/);
float GetSmearedPtData_NoMeanShift(int /*nj*/,int /*ic*/,float /*recopt*/,float /*fpercent*/,const char */*csys*/); //! JFF & JS
float GetSmearedPtData_OnlyMeanShift(int /*nj*/,int /*ic*/,float /*recopt*/,float /*fpercent*/,const char */*csys*/);

//! For PbPb jet energy scale correction for Pu algorithms
float GetPbPbCorrectedScaleMC  (int /*nj*/,int /*hiBin*/,float /*recopt*/,float /*refpt*/); //! JFF & JS
float GetPbPbCorrectedScaleData(int /*nj*/,int /*hiBin*/,float /*recopt*/);  //! JFF & JS

//! Re-weighting factor for data
float GetReWeight(int /*nj*/,int /*ic*/, float /*smpt*/); //! JFF & JS
float GetReWeight_NoMeanShift(int /*nj*/,int /*ic*/, float /*smpt*/); //! JFF & JS

const int NCEN=7;
const int KNJ =7;

//! Smearing function
TF1 *fresol[KNJ][NCEN], *fscale[KNJ][NCEN];
TF1 *fReWe; //! only for 0-10% and 50-100% and ak3PF pp jets


//! For pp we are using jet algorithm w/o pileup subtraction.
//! For PbPb we are suing jet algorithm w pileup subtraction

//! Algorithm ordering
//! 0 : icpu5Calo (not implemented)
//! 1 : ak2PF
//! 2 : ak3PF
//! 3 : ak4PF
//! 4 : ak2Calo
//! 5 : ak3Calo
//! 6 : ak4Calo


//!                             0-5%    5-10%  10-30%  30-50%   50-70%  70-90%   pp 
double resol[KNJ][NCEN][3]={ {{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0}}, //! icpu5calo
			     {
			       {0.0331873,1.5635 , 5.27844}, //! 0-5%
			       {0.0361526,1.52528, 4.7553},  //! 5-10%
			       {0.0500046,1.35665, 5.73554}, //! 10-30%
			       {0.0472502,1.33407, 4.85046}, //! 30-50%
			       {0.0537352,1.26698, 4.80193}, //! 50-70%
			       {0.0582568,1.20534, 4.81982}, //! 70-90%
			       {0.0538121,1.32303, 3.43041}  //! pp
			     }, //! ak2PF
			     {
			       {0.038187 , 1.44825, 7.05917}, //! 0-5%
			       {0.0464146, 1.33934, 7.25445}, //! 5-10%
			       {0.0491429, 1.28628, 6.08477}, //! 10-30%
			       {0.0455849, 1.26814, 4.18584}, //! 30-50% 
			       {0.0534247, 1.12814, 5.05326}, //! 50-70%
			       {0.0589878, 1.03316, 5.11351}, //! 70-90%
			       {0.0565255, 1.15451, 2.95012}  //! pp
			     },//! ak3PF
			     {
			       {0.0324015, 1.47309	,8.51227}, //! 0-5%
			       {0.0438195, 1.33764	,8.41154}, //! 5-10% 
			       {0.0410387, 1.32716	,6.86525}, //! 10-30%
			       {0.0442706, 1.2373	,5.4946},  //! 30-50%
			       {0.0507545, 1.10693	,5.51632}, //! 50-70%
			       {0.0564619, 0.991864	,5.69295}, //! 70-90%
			       {0.0519536, 1.15376	,0.00104096} //! pp
			     }, //! ak4PF
			     {
			       {0.0399 ,1.5972 ,0.0028}, //! 0-5%
			       {0.0308 ,1.6037 ,0.0012}, //! 5-10%
			       {0.0513 ,1.5073 ,2.5962}, //! 10-30%
			       {0.0437 ,1.5398 ,0.0001}, //! 30-50% 
			       {0.0496 ,1.4916 ,0.0001}, //! 50-70%
			       {0.0497 ,1.4863 ,0.8653}, //! 70-90%
			       {0.0525 ,1.4676 ,2.5202}  //! pp
			     }, //! ak2Calo
			     {
			       {0.0394 ,1.5412 ,0.0019},  //! 0-5%
			       {0.0324 ,1.5508 ,0.0002},  //! 5-10%
			       {0.0469 ,1.4673 ,0.0012},  //! 10-30%
			       {0.0443 ,1.4307 ,0.0018},  //! 30-50%
			       {0.047  ,1.393  ,0.0011},  //! 50-70%
			       {0.0472 ,1.3644 ,0.0009},  //! 70-90%
			       {0.0498 ,1.3384 ,0.0003}   //! pp
			     }, //! ak3Calo
			     {
			       {0.0371 ,1.5818 ,0.0003}, //! 0-5%
			       {0.0318 ,1.565  ,0.0004}, //! 5-10% 
			       {0.0427 ,1.4967 ,0.0002}, //! 10-30%
			       {0.044  ,1.4276 ,0.0009}, //! 30-50%
			       {0.0478 ,1.3631 ,0.0002}, //! 50-70%
			       {0.0506 ,1.3126 ,0.0002}, //! 70-90%
			       {0.0516 ,1.2748 ,0.0001}  //! pp
			     }  //! ak4Calo
};


double scale[KNJ][NCEN][3]={ {{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0},{0,0,0}}, //! icpu5calo
                             {
			       {1.00576	 , -4.22398 , 28.5291 },//! 0-5%
			       {1.00275	 , -3.11254 , -17.5346},//! 5-10% 
			       {1.00161	 , -3.1308  , 16.8815}, //! 10-30%
			       {0.997869 , -1.05871 , -60.2062},//! 30-50% 
			       {1.00005	 , -1.2943  , -15.0399},//! 50-70%
			       {0.996327 , 0.340711 , -49.5331},//! 70-90%
			       {1,0,0}  //! pp
			     }, //! ak2PF
                             {
			       {1.00733	 ,-4.17935, 145.421}, //! 0-5%
			       {1.00469	 ,-3.79082, 117.054}, //! 5-10%
			       {1.00295	 ,-3.588  , 89.7086}, //! 10-30%
			       {1.00348	 ,-3.52743, 90.232},  //! 30-50%
			       {1.00356	 ,-3.03035, 71.3934}, //! 50-70%
			       {0.997688 ,-0.478383, -25.3585},//! 70-90% 
			       {1,0,0} //! pp
			     }, //! ak3PF	  
                             {
			       {1.00801	 , -1.35861 , 259.995}, //! 0-5%
			       {1.00729	 , -1.84052 , 230.426}, //! 5-10%
			       {1.00399	 , -2.18056 , 161.522}, //! 10-30%
			       {1.00255	 , -2.56224 , 109.748}, //! 30-50%
			       {1.00312	 , -3.09907 , 98.4685}, //! 50-70%
			       {0.997967 , -1.02259 , -11.8946},//! 70-90%
			       {1,0,0}  //! pp
			     }, //! ak4PF
                             {
			       {1.002  ,-7.8212 ,192.245}, //! 0-5%
			       {1.0069 ,-8.2694 ,237.556}, //! 5-10%
			       {1.002  ,-5.5285 ,137.226}, //! 10-30%
			       {1.0018 ,-3.5169 ,79.8373}, //! 30-50%
			       {1.0051 ,-3.3211 ,86.8717}, //! 50-70%
			       {1.0022 ,-1.5835 ,26.0612},  //! 70-90%
			       {1,0,0}  //! pp
			     }, //! ak2Calo
                             {
			       {0.9978 ,-8.7164 ,307.606}, //! 0-5%
			       {1.0033 ,-9.363  ,356.017}, //! 5-10% 
			       {0.9983 ,-6.1391 ,203.178}, //! 10-30%
			       {1.0009 ,-4.606  ,151.402}, //! 30-50%
			       {1.0036 ,-3.7531 ,95.5906}, //! 50-70%
			       {1.0005 ,-2.0961 ,46.0633}, //! 70-90%
			       {1,0,0}   //! pp
			     }, //! ak3Calo
                             {
			       {0.997  ,-7.8272 ,437.479}, //! 0-5%
			       {1.0003 ,-7.4084 ,394.821}, //! 5-10% 
			       {0.9977 ,-5.571  ,282.378}, //! 10-30%  
			       {1.0009 ,-4.5054 ,201.112}, //! 30-50% 
			       {1.0039 ,-4.2806 ,157.502}, //! 50-70%  
 			       {0.9993 ,-2.339  ,55.9009}, //! 70-90% 
			       {1,0,0} //! pp
			     }  //! ak4Calo
};

//! after burner for mean diff                       
double amdiff[KNJ][NCEN][33]={ {{0},{0},{0},{0},
				{0},{0},{0}}, //! icpu5calo
                               {
				 {0.0239412,0.01243,0.0143796,0.000505626,-0.00131786,0.0141358,-0.00442976,0.00213772,-0.00114882,0.000402868,0.0018369,0.00950521,0.00381398,-0.00156349,-0.000285923,0.00643075,0.00118148,0.000638068,0.0106224,-0.0024339,-0.00566161,0.0171672,0.002267,6.9201e-05,-0.00178653,-0.00182015,0.00878799,0.00130862,0.00111222,-0.00181752,0.00138253,0.00340289,0.00552464}, //! 0-5%
				 {0.0180368,0.00527436,0.00911248,-0.00301123,0.0152886,0.0123391,-0.0171759,-0.00536734,0.00135446,-0.00401354,0.0036822,0.00432181,0.00690466,0.00711948,0.00195038,-0.000469983,0.0110755,-0.0067665,0.00263351,-0.00372314,-0.00377512,0.0130012,0.00827807,-0.00378406,-0.00551111,0.00506836,0.0125707,-0.00443441,0.00259203,0.00498235,0.00615728,-0.00267005,0.0045433}, //! 5-10%
				 {-0.00298578,-0.00197583,0.0117723,0.00480539,0.00675088,0.00555003,-0.00230259,-0.00404507,-0.00529146,-0.00280112,-0.00271034,0.00290549,0.00630212,0.0109406,-0.000270367,0.0075264,0.0113877,0.00128502,0.00512886,-0.00858867,-0.0066945,0.0159115,-0.000799716,0.00842524,-0.0100992,0.00487304,0.00603622,-0.00134212,0.00139964,-0.00596696,-0.00298631,0.00672066,0.00374007}, //! 10-30%
				 {0.0159886,0.0117351,0.0111744,0.0079124,0.0018732,0.00147218,0.00596976,-0.000104249,-0.00558257,-0.00185359,0.00210446,0.00421846,0.00360948,0.00897342,0.000481665,0.0020231,0.0128304,0.000904322,0.00705063,-0.00379092,-0.00811958,0.010891,4.31538e-05,0.00839055,-0.00302792,0.00858408,0.0102143,0.000877321,-0.00516325,-0.00359613,-0.00322837,0.00372231,0.00214446}, //! 30-50%
				 {0.00907046,0.00839227,0.00966918,0.00977111,0.00452095,-0.0026018,0.0012759,0.00421834,-0.00492626,-0.000146508,0.00156122,0.00139749,0.00457841,0.0119306,-0.000428915,0.00253266,0.0116203,-0.00200152,0.00180191,0.00216228,-0.00886106,0.0135353,0.00320607,0.00971735,-0.00658941,0.00722986,0.00130761,0.00301373,-0.00343943,-0.00172973,0.00235015,0.00183892,0.00305146}, //! 50-70%
				 {0.0066371,0.00577068,0.0124451,0.00754064,0.00320292,0.00212824,0.00348872,-0.00321072,-0.0115995,-0.00157541,-0.00335181,0.011375,0.00554776,0.0119193,0.00823766,0.00602472,0.00506467,-0.00307351,0.00216413,0.00133753,-0.00281668,0.0130697,0.00464362,0.00522619,0.00135881,-0.000138402,0.00343561,0.00129431,0.00398809,-0.00539625,7.24792e-05,-6.98566e-05,-0.0019787}, //! 70-90%
				 {0}  //! pp
			       }, //! ak2PF
                               {
				 {-0.0957503,-0.0366432,-0.00239193,-0.00111985,0.00406867,0.0129364,-0.000904024,0.00290388,0.000446916,0.014991,0.00441539,0.0102446,7.05719e-05,-0.0119217,-0.00174958,-0.000980139,0.00811815,0.00433797,0.00240582,-0.00321567,-0.00202787,0.00674027,0.000503898,3.97563e-05,0.00317174,0.000580072,0.00688094,0.00317574,-0.000688612,-0.00319052,0.0101621,0.00435334,0.00570643},//! 0-5%
				 {-0.105525,-0.0316963,-0.00745112,-0.00189686,0.00352544,0.00309801,-0.00600392,-0.0121201,0.00319189,0.0059008,0.000226438,0.00754851,0.00883555,-0.00923926,0.0188677,-0.00176173,0.00513905,0.00692612,0.00295156,-0.00486153,-0.00638604,-0.0018059,0.00472921,-0.00532085,-0.000431478,0.00263381,0.00789589,0.000686705,0.00072521,0.00738513,0.00688565,-0.00357831,0.00438887},//! 5-10%
				 {-0.0516163,-0.00960845,-0.00638938,0.00395107,0.00338864,0.00748146,0.00172335,0.000775218,-0.0170699,-0.00944746,-0.00334263,-0.000624597,0.00544232,-0.000833631,0.0170863,0.00166899,0.0073728,0.0096156,0.00508732,-0.0119,-0.00246751,0.0054419,0.00258797,-0.00117266,-0.000197947,-0.00679743,0.00264871,0.00251925,-0.000521064,-0.00134331,0.0041877,-0.000174522,0.004668},//! 10-30%
				 {-0.0296276,-0.0102345,-0.00182575,0.00346065,-0.000382781,0.00336576,0.00171405,0.000446558,-0.00463557,-0.00347996,-0.000578165,0.000472009,0.00233442,-0.00186092,0.01033,0.00327784,0.00852287,0.00558299,0.00221169,-0.00364447,-0.00356013,0.000103354,0.00445223,0.000342906,-0.00261116,0.00263554,0.0114818,0.00180966,-0.00305378,-0.0103016,0.00147146,0.00506431,0.00155097},//! 30-50%
				 {-0.031548,-0.00918972,-0.00248939,-0.000692368,0.000444174,0.00123191,0.0023036,0.000940561,-0.00794965,-0.00277925,-0.00262636,0.000455439,0.00198525,-0.00150663,0.0165374,0.000724912,0.00977331,0.00610918,-0.00144237,-0.00246561,-0.00128436,0.00214124,0.00414962,0.0038625,1.8537e-05,-0.000538766,0.00695884,0.00556296,-0.00397176,-0.00839287,0.00705308,0.000589132,0.00280684},//! 50-70%
				 {-0.018268,-0.00804049,0.000407219,0.00383049,0.00274009,-0.00042206,-0.000943899,-0.00426054,-0.00859624,-0.00543714,-0.00393707,0.000441194,0.00764209,-0.00200003,0.0171912,0.00492692,0.00745159,0.00339669,0.00219131,-0.0038476,0.00133491,0.00189805,0.00218612,0.00452137,0.00087893,-0.00327235,0.00359207,0.00202942,0.00302291,-0.00834006,0.00341874,-0.00160706,-0.00174284},//! 70-90%
				 {0} //! pp
			       }, //! ak3PF
                               {
				 {-0.0127124,-0.00598019,0.0171051,0.00119317,-0.00346321,0.00694638,-0.00738776,0.00591868,-0.00169849,0.00939095,0.003739,0.0082643,-0.00253433,-0.0124138,0.000649095,-0.000511825,0.00873768,-1.03712e-05,0.00254047,-0.00194591,-0.00522834,0.00782293,0.000170052,5.25117e-05,0.0036006,-0.00140399,0.00635427,0.00329226,-0.000954032,-0.00322616,0.0107534,0.00533843,0.00623101},//! 0-5%
				 {-0.0301312,-0.00641578,0.0107445,0.00492507,0.00387597,0.00327742,-0.0112711,-0.0110382,0.00213593,0.00252652,-0.00120747,0.00749069,0.0046578,-0.0117459,0.0176239,-0.00368863,0.0012641,0.00351328,0.00133175,-0.00312757,-0.00560999,-0.00240052,0.00250256,-0.00371259,0.00106132,-0.00011462,0.00878227,0.000581324,-0.000164211,0.00783348,0.00587869,-0.00223535,0.00570685},//! 5-10%
				 {-0.0199876,-0.00111932,0.0117522,0.00957417,0.0051834,0.0051254,-0.0019294,0.00262815,-0.0177857,-0.00988227,-0.00379318,-0.00124007,0.00637007,0.000297964,0.0170801,-0.000648499,0.00726557,0.00887084,0.00441515,-0.0105748,-0.0074079,0.00457609,0.00218737,-0.00267065,0.000511229,-0.00580484,0.00424474,0.00351477,-0.00273573,-0.0018695,0.00455701,0.000540853,0.0050236},//! 10-30%
				 {-0.037591,-0.0087679,0.0113178,0.00869817,0.000976503,0.00380665,-0.000551999,8.15988e-05,-0.00668401,-0.00397885,-0.00093776,0.00108021,0.00158101,-0.00303012,0.0101748,0.00378764,0.0084042,0.00755316,0.00213617,-0.00399554,-0.0038929,0.000941753,0.00513417,0.001037,-0.00230628,0.00285375,0.0116087,0.00216866,-0.00278056,-0.0100698,0.00179732,0.00547415,0.00184155},//! 30-50%
				 {-0.0346615,-0.00257123,0.0121688,0.00340623,0.00191236,0.000513136,-1.82986e-05,0.00200391,-0.00782925,-0.00323248,-0.00229836,0.0013119,0.00223309,-0.00133055,0.0167521,0.000724912,0.00977373,0.00609052,-0.00153118,-0.0025562,-0.00151426,0.00198376,0.00398856,0.00363183,-0.000365019,-0.000891984,0.00612265,0.00515777,-0.00431561,-0.00892586,0.00650108,0.000134349,0.00234717}, //! 50-70%
				 {-0.0302156,-0.00475556,0.0109398,0.00750124,0.00389731,-1.66893e-05,-0.00231707,-0.00292313,-0.00947666,-0.00548315,-0.00363231,0.000988305,0.00792807,-0.00175643,0.0174814,0.00530344,0.0075919,0.00369561,0.00294036,-0.00367105,0.00138885,0.00202137,0.00243568,0.00452137,0.00087893,-0.00327235,0.00359207,0.00202942,0.00302291,-0.00834006,0.00341874,-0.00160706,-0.00183988},//! 70-90%
				 {0}  //! pp
			       }, //! ak4PF
                               {
				 {0.06,0.03,0.03,0.009,0.00200003,0.015,-0.00400001,0.00600004,0.00300002,0.00199997,0.00599998,0.009,0.00800002,-0.011,0.00400001,0.009,0.009,0.00599998,0.009,0.00399995,-0.00599998,0.021,0.00200003,0.00100005,-0.00199997,-0.00599998,0.005,-0.000999987,-0.000999987,-0.00200003,0.00199997,0.00299996,0.00600004},//! 0-5%
				 {0.042,0.014,0.024,0.017,0.025,0.013,-0.00300002,0.00600004,0.005,-0.005,-0.00199997,0.005,0.017,0,0.00199997,0.00599998,0.014,-0.013,0.00199997,-0.000999987,0.00300002,0.013,0.00599998,0.00300002,-0.00400001,0.00200003,0.009,-0.00300002,0.00400001,0.00599998,0.00700003,0.00700003,0.00800002},//! 5-10%
				 {0.052,0.018,0.025,0.024,0.018,0.005,-0.00199997,0.000999987,-0.00400001,-0.000999987,-0.000999987,-0.000999987,0.00700003,0.00699997,0.005,0.005,0.015,0.00400001,0.005,-0.00500005,-0.00599998,0.016,-0.00400001,0.00100005,-0.013,0.014,0.00799996,-0.00400001,0.00199997,-0.00400001,0.00200003,0.00999999,0.005}, //! 10-30%
				 {0.064,0.027,0.027,0.025,0.013,0.00599998,0.009,0.000999987,-0.00200003,-0.00599998,0.000999987,0.00400001,0.00400001,0.00300002,0.00600004,0.011,0.011,0.000999987,0.014,0.000999987,-0.00999999,0.016,0.00199997,0.00999999,-0.005,0.00999999,0.00199997,-0.000999987,-0.00200003,-0.00299996,-0.00199997,0.00700003,0}, //! 30-50%
				 {0.0650001,0.026,0.03,0.023,0.00700003,0.00399995,0,0.00800002,0,-0.00199997,0.005,0.000999987,0.00999999,0.005,-0.00100005,0.00300002,0.00999999,0,0.00800002,0.00400001,-0.00600004,0.017,0.00599998,0.019,-0.005,0.009,0.00299996,0,-0.00400001,-0.005,0.00200003,0.00400001,0}, //! 50-70%
				 {0.0753213,0.0270674,0.032062,0.0203808,0.00589484,0.00285006,0.00106025,-0.000868142,-0.0090422,0.000123739,-0.00263417,0.00708586,0.00834715,0.0037114,0.00725406,0.00861037,0.0101302,-0.000962138,0.00621468,-0.00107175,-0.00291574,0.0146465,0.00450313,0.00585949,-0.00101471,6.58631e-05,-0.000677466,-0.00035423,0.00839192,-0.00586259,0.0023436,0.0013566,-0.00563544},//! 70-90%
				{0}
			       }, //! ak2Calo
                               {
				 {-0.00600004,-0.005,0.021,0.011,0,0.005,0.005,0.00200003,0.00199997,-0.000999987,-0.000999987,0.005,-0.00200003,-0.00699997,-0.005,0.000999987,0.016,0.00400001,-0.00199997,0,-0.00599998,0.00799996,0.00700003,-0.00200003,0.00400001,-0.00300002,0.00699997,0.000999987,0,-0.005,0.00599998,0.011,0.005}, //! 0-5%
				 {-0.04,-0.019,0.019,0.015,0.015,0.013,-0.00600004,0.00100005,0.011,-0.005,-0.00599998,0,0.005,-0.018,0.011,-0.00400001,0.00700003,0.000999987,-0.00999999,-0.00599998,0.00300002,0,0.00700003,-0.00400001,-0.00200003,-0.00699997,0.00599998,0.00300002,0,0.00599998,0.00700003,0.005,0.009}, //! 5-10%
				 {-0.00300002,0.00400001,0.019,0.022,0.014,0.005,0,0,-0.011,-0.012,-0.00500005,-0.005,-0.00100005,0,0.00700003,0.00800002,0.013,0.00700003,0,-0.00599998,0,0.009,0,-0.00400001,-0.000999987,-0.00999999,0.00399995,0.00200003,0.00300002,-0.00399995,0.00200003,-0.000999987,0.00700003}, //! 10-30%
				 {-0.00199997,0.00700003,0.021,0.021,0.012,0.00600004,-0.000999987,-0.00599998,-0.00300002,-0.00400001,-0.005,-0.00299996,0.00200003,-0.00700003,0.011,0.005,0.011,0.00800002,0.000999987,0,-0.005,0.00799996,0.00600004,0.00700003,0,0.00599998,0.00800002,0.00199997,-0.00400001,-0.00600004,0.00199997,0.00899994,0.00299996}, //! 30-50%
				 {0.019,0.018,0.025,0.016,0.00600004,0.00400001,0.00300002,-0.000999987,-0.00200003,-0.00199997,-0.00699997,0.00199997,0.00300002,0,0.009,0.000999987,0.011,0.005,-0.00299996,0.000999987,0.00299996,0.005,0.00300002,0.00599998,0.00199997,-0.00200003,0.00599998,0.00599998,-0.00399995,-0.00600004,0.00299996,0.005,0.00199997}, //! 50-70%
				 {0.0256363,0.0165555,0.0257425,0.0197635,0.00939542,0.00136125,-0.00274044,-0.00444716,-0.0047996,-0.00153309,-0.00580335,-0.00216252,0.00850827,-0.00118458,0.0127303,0.00745279,0.0162293,0.00485444,0.00103062,0.0015474,0.0034411,0.00270063,0.00450158,0.00628638,0.00291497,-0.00409913,0.00238895,0.00120568,-7.03335e-06,-0.00733352,0.00349694,-0.00231963,7.27773e-05}, //! 70-90%
				 {0} //! pp
			       }, //! ak3Calo
                               {
				 {-0.045,-0.011,0.017,0.022,0.005,0,0.00400001,-0.00400001,0.00699997,0.012,-0.00299996,0.00500005,0.005,-0.00800002,-0.013,0.00700003,0.009,0.000999987,0.011,-0.00199997,-0.00300002,-0.013,0.00400001,0.00100005,0.00299996,-0.00200003,0.00999999,-0.00299996,-0.00400001,-0.00500005,0.000999987,0.00300002,0.00799996}, //! 0-5%
				 {-0.057,-0.018,0.014,0.016,0.011,0.012,0.005,-0.00800002,0.00100005,0.005,-0.011,0.00300002,0.009,-0.00699997,0.0100001,0.00999999,-0.00200003,-0.00400001,-0.00999999,-0.005,-0.009,0.000999987,0.00799996,0.00199997,0.000999987,0,0.00400001,0.00400001,-0.00300002,0.000999987,0.00799996,-0.00100005,0.005}, //! 5-10%
				 {-0.02,-0.00899994,0.018,0.023,0.014,-0.00199997,0.00100005,0.00599998,0.000999987,-0.005,-0.00300002,-0.00599998,0.00100005,-0.00400001,0.00300002,0.00700003,0.011,0.00999999,0.00599998,-0.00300002,0.00100005,-0.00400001,0.009,-0.00200003,0.00800002,-0.005,0.00800002,-0.000999987,-0.000999987,-0.00199997,0.00200003,0,0.005}, //! 10-30%
				 {-0.016,0.00199997,0.017,0.0179999,0.00400001,0.000999987,0.00200003,0.00599998,0.000999987,0.000999987,0,0,-0.00200003,-0.00299996,0.00200003,0.012,0.00800002,0.00300002,0.00400001,0,-0.005,-0.00799996,0.00599998,0.00400001,0.00500005,0.00300002,0.011,0.00599998,-0.00800002,-0.00300002,0,0,0.00199997}, //! 30-50%
				 {-0.00699997,-0.00100005,0.019,0.02,0.005,-0.000999987,0,0.00300002,0.00400001,-0.00100005,-0.00100005,0.000999987,0.005,0.00299996,0.00700003,0.00600004,0.00400001,0.00700003,-0.000999987,-0.000999987,-0.00199997,-0.00300002,0.00400001,0.00599998,0.011,-0.00400001,0.00799996,0.00400001,-0.005,-0.00800002,0,0.00199997,0.00199997}, //! 50-70%
				 {0.014301,0.00997519,0.0178463,0.0231685,0.0103662,-0.00575352,-0.00308955,-0.000867724,-0.00343215,0.00327927,-0.00803959,0.000493944,0.0075087,-0.00514048,0.00537652,0.0118487,0.00884092,0.00949633,0.00617182,-0.000697851,0.00202638,-0.000724435,0.0052098,0.00487316,0.0090428,0.000247598,0.00129449,0.00417554,4.8697e-05,-0.00797844,-0.00202984,-0.00157261,-0.000740826}, //! 70-90%
				 {0} //! pp
			       } //! ak4Calo
};


//! Reweighting factor for 0-10% and 50-100% only for data
double fwe010[2][3] = {{2.32745e+00, -9.63227e+01, 5.88044e+03}, //! 0-5%                                                                  
		       {1.13736e+00,  2.20014e+02,-1.28424e+04}  //! 5-10%                                                                 
};
double fwe50100[2][3] = {{2.30339e+00,  -8.18276e+01,  5.35947e+03}, //! 50-70%                                                            
			 {1.50452e+00,   1.20980e+02, -7.33869e+03}  //! 70-100%                                                           
};
//! Reweighting factor for 0-10% and 50-100% only for data - No Mean Shift for pp
double fwe010_noms[2][3] = {{1.94440e+00,  9.70262e+00, -3.85305e+02}, //! 0-5%
			    {1.72225e+00,  6.63995e+01, -3.86893e+03}  //! 5-10%
};
double fwe50100_noms[2][3] = {{2.05212e+00, -1.58706e+01,  9.43296e+02}, //! 50-70%
			      {1.94988e+00,  1.51774e+01, -8.94539e+02}  //! 70-100%
};



double PT_BINS[34] = {30,40,50,60,70,80,90,100,
		      110,120,130,140,150,160,170,180,190,200,
		      210,220,230,240,250,260,270,280,290,300,
		      310,320,330,340,350,400};
const int NBINS=34;

void LoadParameters()
{
  for(int nj=0;nj<KNJ;nj++){
    for(int i=0;i<NCEN;i++){
      fresol[nj][i]  = new TF1(Form("fresol%d_%d",nj,i),"sqrt(pow([0],2)+pow([1]/sqrt(x),2)+pow([2]/x,2))",30,400);
      fscale[nj][i] = new TF1(Form("fscale%d_%d",nj,i),"[0] + [1]/x + [2]/x/x"  ,30,400);
      for(int im=0;im<3;im++){
	fresol[nj][i]->SetParameter(im,resol[nj][i][im]);
	fscale[nj][i]->SetParameter(im,scale[nj][i][im]);
      }
    }
  }

  //! Reweight factor for 0-10% and 50-100%
  fReWe = new TF1("fReWe","[0] + [1]/x + [2]/x/x",30,400);
}



//////////////////////////////////////////////////MC related functions///////////////////////////////////////////////////////////////
float GetSmearedPtMC(int nj,int ic,float recopt,float refpt)
{
  int icen = ic;

  //! Get the jet energy scale
  float mpp   = fscale[nj][NCEN-1]->Eval(refpt);
  float mpbpb = fscale[nj][icen]->Eval(refpt);

  //! Calculate the shift in scale
  float mdf = mpp - mpbpb;

  //! Now shift scale first
  float smpt = recopt - mdf*recopt;

  //! afterburn to adjust the remaining residual
  smpt = AfterBurnMean(nj,icen,smpt,refpt);
  
  //! Get resolutions
  float rpp   = fresol[nj][NCEN-1]->Eval(refpt); //! pp
  float rpbpb = fresol[nj][icen]->Eval(refpt);   //! PbPb
  
  //! Calculate the smearing factor
  float smf = 0;
  if(rpp>rpbpb){
    smf=0;
  }else{
    smf = sqrt(pow(rpbpb,2) - pow(rpp,2))*refpt;
  }
  //! Smearing the recopt
  smpt = gRandom->Gaus(smpt,smf);


  return smpt;
}
float GetSmearedPtMC_woAfBurn(int nj,int ic,float recopt,float refpt)
{
  int icen = ic;

  //! Get the jet energy scale
  float mpp   = fscale[nj][NCEN-1]->Eval(refpt);
  float mpbpb = fscale[nj][icen]->Eval(refpt);

  //! Calculate the shift in scale
  float mdf = mpp - mpbpb;

  //! Now shift scale first
  float smpt = recopt - mdf*recopt;

  //! afterburn to adjust the remaining residual
  //smpt = AfterBurnMean(nj,icen,smpt,refpt);
  
  //! Get resolutions
  float rpp   = fresol[nj][NCEN-1]->Eval(refpt); //! pp
  float rpbpb = fresol[nj][icen]->Eval(refpt);     //! PbPb
  
  //! Calculate the smearing factor
  float smf = 0;
  if(rpp>rpbpb){
    smf=0;
  }else{
    smf = sqrt(pow(rpbpb,2) - pow(rpp,2))*refpt;
  }
  //! Smearing the recopt
  smpt = gRandom->Gaus(smpt,smf);
  return smpt;
}
float GetPbPbCorrectedScaleMC(int nj,int hibin,float recopt,float refpt)
{
  if(nj==0)return recopt; //! no icpu5 jets

  int icen = GetCBin(hibin);
  //! Get the jet energy scale
  float mpbpb = fscale[nj][icen]->Eval(refpt);

  //! Now correct scale first
  float corr_recopt = recopt/mpbpb;

  return corr_recopt;
}
float GetSmearedPtMC_NoMeanShift(int nj,int ic,float recopt,float refpt)
{
  int icen = ic;
  float smpt = recopt;
  //! Get resolutions
  float rpp   = fresol[nj][NCEN-1]->Eval(refpt); //! pp
  float rpbpb = fresol[nj][icen]->Eval(refpt);   //! PbPb
  
  //! Calculate the smearing factor
  float smf = 0;
  if(rpp>rpbpb){
    smf=0;
  }else{
    smf = sqrt(pow(rpbpb,2) - pow(rpp,2))*refpt;
  }
  //! Smearing the recopt
  smpt = gRandom->Gaus(smpt,smf);
  return smpt;
}
float GetSmearedPtMC_OnlyMeanShift(int nj,int ic,float recopt,float refpt)
{
  int icen = ic;
  //! Get the jet energy scale
  float mpp   = fscale[nj][NCEN-1]->Eval(refpt);
  float mpbpb = fscale[nj][icen]->Eval(refpt);

  //! Calculate the shift in scale
  float mdf = mpp - mpbpb;

  //! Now shift scale first
  float smpt = recopt - mdf*recopt;
  return smpt;
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


/////////////////////////////////////////////////////// Data related functions ////////////////////////////////////////////
float GetSmearedPtData(int nj,int ic,float recopt,float fpercent,const char *csys)
{
  if(recopt<60)return recopt;

  int icen = ic;

  //! Mean shift
  float mpp   = fscale[nj][NCEN-1]->Eval(recopt);
  float mpbpb = fscale[nj][icen]->Eval(recopt);
  float mdf   = mpp - mpbpb;

  //! Get resolutions
  float rpp   = fresol[nj][NCEN-1]->Eval(recopt); //! pp
  float rpbpb = fresol[nj][icen]->Eval(recopt);   //! PbPb

  float smf=0;
  float smpt=0;

  //! Calculate the smearing factor
  if(rpp>rpbpb){
    smf=0;
  }else{
    smf = sqrt(pow(rpbpb,2) - pow(rpp,2))*recopt;
  }

  if(strcmp(csys,"low")==0){

    smpt = recopt - ((mdf - (2.*fpercent/100.)*mdf)*recopt);
    smpt = AfterBurnMean(nj,icen,smpt,recopt);
    smf  = smf - (fpercent/100.)*smf;

  }else if(strcmp(csys,"up")==0){

    smpt = recopt - ((mdf + (2.*fpercent/100.)*mdf)*recopt);
    smpt = AfterBurnMean(nj,icen,smpt,recopt);
    smf  = smf + (fpercent/100.)*smf;

  }else{

    //! Now shift scale first
    smpt = recopt - mdf*recopt;
    
    //! afterburn to adjust the remaining residual in mean shift
    smpt = AfterBurnMean(nj,icen,smpt,recopt);
  }

  //! Smearing the recopt
  smpt = gRandom->Gaus(smpt,smf);  
  return smpt;
}
float GetSmearedPtData_woAfBurn(int nj,int ic,float recopt,float fpercent,const char *csys)
{
  if(recopt<60)return recopt;

  int icen = ic;

  //! Mean shift
  float mpp   = fscale[nj][NCEN-1]->Eval(recopt);
  float mpbpb = fscale[nj][icen]->Eval(recopt);
  float mdf   = mpp - mpbpb;

  //! Get resolutions
  float rpp   = fresol[nj][NCEN-1]->Eval(recopt); //! pp
  float rpbpb = fresol[nj][icen]->Eval(recopt);   //! PbPb

  float smf=0;
  float smpt=0;

  //! Calculate the smearing factor
  if(rpp>rpbpb){
    smf=0;
  }else{
    smf = sqrt(pow(rpbpb,2) - pow(rpp,2))*recopt;
  }

  if(strcmp(csys,"low")==0){

    smpt = recopt - ((mdf - (2.*fpercent/100.)*mdf)*recopt);
    //smpt = AfterBurnMean(nj,icen,smpt,recopt);
    smf  = smf - (fpercent/100.)*smf;

  }else if(strcmp(csys,"up")==0){

    smpt = recopt - ((mdf + (2.*fpercent/100.)*mdf)*recopt);
    //smpt = AfterBurnMean(nj,icen,smpt,recopt);
    smf  = smf + (fpercent/100.)*smf;

  }else{

    //! Now shift scale first
    smpt = recopt - mdf*recopt;
    
    //! afterburn to adjust the remaining residual
    //smpt = AfterBurnMean(nj,icen,smpt,recopt);
  }

  //! Smearing the recopt
  smpt = gRandom->Gaus(smpt,smf);  
  return smpt;
}
float GetSmearedPtData_NoMeanShift(int nj,int ic,float recopt,float fpercent,const char *csys)
{
  if(recopt<60)return recopt;

  int icen = ic;

  float smpt = recopt;
  //! Get resolutions
  float rpp   = fresol[nj][NCEN-1]->Eval(recopt); //! pp
  float rpbpb = fresol[nj][icen]->Eval(recopt);     //! PbPb
  
  //! Calculate the smearing factor
  float smf = 0;
  if(rpp>rpbpb){
    smf=0;
  }else{
    smf = sqrt(pow(rpbpb,2) - pow(rpp,2))*recopt;
  }

  if(strcmp(csys,"low")==0){
    smf  = smf - (fpercent/100.)*smf;
  }else if(strcmp(csys,"up")==0){
    smf  = smf + (fpercent/100.)*smf;
  }

  //! Smearing the recopt
  smpt = gRandom->Gaus(smpt,smf);
  return smpt;
}
float GetSmearedPtData_OnlyMeanShift(int nj,int ic,float recopt,float fpercent,const char *csys)
{
  if(recopt<60)return recopt;

  int icen = ic;
  //! Get the jet energy scale
  float mpp   = fscale[nj][NCEN-1]->Eval(recopt);
  float mpbpb = fscale[nj][icen]->Eval(recopt);

  //! Calculate the shift in scale
  float mdf = mpp - mpbpb;
  float smpt=recopt;

  if(strcmp(csys,"low")==0){
    smpt = recopt - ((mdf - (2.*fpercent/100.)*mdf)*recopt);
    smpt = AfterBurnMean(nj,icen,smpt,recopt);

  }else if(strcmp(csys,"up")==0){
    smpt = recopt - ((mdf + (2.*fpercent/100.)*mdf)*recopt);
    smpt = AfterBurnMean(nj,icen,smpt,recopt);

  }else{
    smpt = recopt - mdf*recopt;
    smpt = AfterBurnMean(nj,icen,smpt,recopt);
  }
  return smpt;
}
float GetPbPbCorrectedScaleData(int nj,int hibin,float recopt)
{
  if(recopt<60)return recopt;

  int icen = GetCBin(hibin);
  //! Get the jet energy scale
  float mpbpb = fscale[nj][icen]->Eval(recopt);

  //! Now correct scale first
  float corr_recopt = recopt/mpbpb;
  return corr_recopt;
}
float GetReWeight(int nj,int ic,float smpt)
{
  //! Only to be used for pp data 

  float rewe=1;
  if(smpt<60)return rewe;
  
  if(ic==0 || ic==1){ //! 0-10%
    fReWe->SetParameters(fwe010[ic][0],fwe010[ic][1],fwe010[ic][2]);
    rewe = 1./fReWe->Eval(smpt);
  }
  else if(ic==4 || ic==5){//! 50-100%
    fReWe->SetParameters(fwe50100[ic-4][0],fwe50100[ic-4][1],fwe50100[ic-4][2]);
    rewe = 1./fReWe->Eval(smpt);
  }
  return rewe;
}
float GetReWeight_NoMeanShift(int nj,int ic,float smpt)
{
  float rewe=1;
  if(smpt<60)return rewe;

  if(ic==0 || ic==1){ //! 0-10%
    fReWe->SetParameters(fwe010_noms[ic][0],fwe010_noms[ic][1],fwe010_noms[ic][2]);
    rewe = 1./fReWe->Eval(smpt);
  }
  else if(ic==4 || ic==5){//! 50-100%
    fReWe->SetParameters(fwe50100_noms[ic-4][0],fwe50100_noms[ic-4][1],fwe50100_noms[ic-4][2]);
    rewe = 1./fReWe->Eval(smpt);
  }
  return rewe;
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////







////////////////////////////////////////////////Common functions////////////////////////////////////////////////////////////
float GetSmFactor(int nj,int ic,float recopt)
{
  int icen = ic;
  //! Get resolutions
  float rpp   = fresol[nj][NCEN-1]->Eval(recopt); //! pp
  float rpbpb = fresol[nj][icen]->Eval(recopt);     //! PbPb

  float smf=0;
  //! Calculate the smearing factor
  if(rpp>rpbpb){
    smf=0;
  }else{
    smf = sqrt(pow(rpbpb,2) - pow(rpp,2))*recopt;
  }
  return smf;
}
float GetMeanShift(int nj,int ic,float recopt)
{
  int icen = ic;
  //! Mean shift
  float mpp   = fscale[nj][NCEN-1]->Eval(recopt);
  float mpbpb = fscale[nj][icen]->Eval(recopt);
  float mdf   = mpp - mpbpb;

  return mdf;
}
int GetCBin(int bin)
{
  int ibin=-1;
  //! centrality is defined as 2.5% bins of cross section
  //! in 0-39 bins
  if(bin<2)ibin=0;                  //! 0-5%
  else if(bin>=2 && bin<4)ibin=1;   //! 5-10%
  else if(bin>=4 && bin<12)ibin=2;  //! 10-30%
  else if(bin>=12&& bin<20)ibin=3;  //! 30-50%
  else if(bin>=20&& bin<28)ibin=4;  //! 50-70%
  else if(bin>=28&& bin<36)ibin=5;  //! 70-90%
  else ibin=5; //! 90-100% use the same 70-90% factors
  return ibin;
}
float AfterBurnMean(int nj,int ic,float smpt,float refpt)
{
  int icen = ic;
  int ib = GetPtBin(refpt);
  if(smpt<50)return smpt; //! do not shift this
  else{
    smpt += smpt*amdiff[nj][icen][ib];
  }
  return smpt;
}
float GetPtBin(float pt)
{
  for(int i=0;i<NBINS-1;i++){
    if(pt>=PT_BINS[i] && pt<PT_BINS[i+1])return i;
  }
  return -1;
}
#endif
